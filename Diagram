//// -----------------------------------------------------------
//// -- Project: Smart City DB
//// -- Database: PostgreSQL with PostGIS
//// -- Last Updated: 2025-10-4
//// -----------------------------------------------------------


Enum gender {
  male
  female
  none
}

Enum freecycle_request_status {
  pending
  accepted
  rejected
}

Enum volunteer_event_status {
  draft
  pending
  approved
  rejected
}

Enum course_type {
  online
  onsite
  online_and_onsite
}

Enum wallet_type {
  individual
  organization
}

Enum wallet_status {
  active
  suspended
}

Enum transaction_type {
  top_up
  transfer_in
  transfer_out
  transfer_to_service
}

Enum card_transaction_type {
  top_up
  charge
  refund
}

Enum transaction_category {
  insurance
  metro
}

Enum air_quality_category {
  good
  moderate
  unhealthy
  hazardous
}

Enum report_level {
  near_miss
  minor
  moderate
  major
  lethal
}

Enum report_status {
  pending
  verified
  resolved
}

Enum sos_status {
  open
  closed
}

Enum alert_status {
  read
  unread
  sent
}

/* Core lookups */
Table roles {
  id int [pk, increment]
  role_name varchar [not null, unique]
}

Table departments {
  id int [pk, increment]
  department_name varchar [not null, unique]
  created_at timestamptz
  updated_at timestamptz
}

/* Addresses used by many entities */
Table addresses {
  id int [pk, increment]
  address_line text
  province varchar
  district varchar
  subdistrict varchar
  postal_code varchar
  location geometry //PostGIS Point(4326)
  created_at timestamptz
  updated_at timestamptz
}

/* Users & profiles */
Table users {
  id int [pk, increment]
  username varchar [not null, unique]
  email varchar [not null, unique]
  phone varchar [unique]
  password_hash varchar [not null]
  role_id int [ref: > roles.id]
  created_at timestamptz
  updated_at timestamptz
  last_login timestamptz
}

Table user_profiles {
  user_id int [pk, ref: > users.id]
  first_name varchar
  middle_name varchar
  last_name varchar
  birth_date date
  gender gender
  address_id int [ref: > addresses.id]
  more_address_detail text
}

/* Many-to-many */
Table users_departments {
  user_id int [ref: > users.id]
  department_id int [ref: > departments.id]
  Indexes {
    (user_id, department_id) [pk]
  }
}

/* Auth */
Table sessions {
  session_id uuid [pk]
  user_id int [ref: > users.id]
  created_at timestamptz
  expires_at timestamptz
  last_accessed timestamptz
}

Table refresh_tokens {
  id int [pk, increment]
  user_id int [ref: > users.id]
  refresh_token text
  created_at timestamptz
  expires_at timestamptz
}

/* G4: Freecycle */
Table freecycle_categories {
  id int [pk, increment]
  category_name varchar [not null, unique]
  created_at timestamptz
  updated_at timestamptz
}

Table freecycle_posts {
  id int [pk, increment]
  item_name varchar [not null]
  item_weight numeric
  photo_url text
  description text
  donater_id int [ref: > users.id]
  donate_to_department_id int [ref: > departments.id]
  is_given boolean
  created_at timestamptz
  updated_at timestamptz
}

Table freecycle_posts_categories {
  post_id int [ref: > freecycle_posts.id]
  category_id int [ref: > freecycle_categories.id]
  Indexes {
    (post_id, category_id) [pk]
  }
}

Table receiver_requests {
  id int [pk, increment]
  post_id int [ref: > freecycle_posts.id]
  receiver_id int [ref: > users.id]
  status freecycle_request_status
  created_at timestamptz
  updated_at timestamptz
}

/* G6: Volunteer events */
Table volunteer_events {
  id int [pk, increment]
  created_by_user_id int [ref: > users.id]
  department_id int [ref: > departments.id]
  image_url text
  title varchar [not null]
  description text
  current_participants int
  total_seats int
  start_at timestamptz
  end_at timestamptz
  registration_deadline timestamptz
  address_id int [ref: > addresses.id]
  status volunteer_event_status
  created_at timestamptz
  updated_at timestamptz
}

Table volunteer_event_participation {
  id int [pk, increment]
  volunteer_event_id int [ref: > volunteer_events.id]
  user_id int [ref: > users.id]
  created_at timestamptz
}

/* G1: Courses */
Table courses {
  id int [pk, increment]
  author_id int [ref: > users.id]
  course_name varchar [not null]
  course_description text
  course_type course_type
  cover_image text
  created_at timestamptz
  updated_at timestamptz
}

Table course_videos {
  id int [pk, increment]
  course_id int [ref: > courses.id]
  video_name varchar
  video_description text
  duration_minutes int
  video_order int
  video_file_path text
  created_at timestamptz
  updated_at timestamptz
}

Table onsite_sessions {
  id int [pk, increment]
  course_id int [ref: > courses.id]
  address_id int [ref: > addresses.id]
  duration_hours numeric
  event_at timestamptz
  registration_deadline timestamptz
  total_seats int
  created_at timestamptz
  updated_at timestamptz
}

Table onsite_enrollments {
  id int [pk, increment]
  onsite_id int [ref: > onsite_sessions.id]
  user_id int [ref: > users.id]
  created_at timestamptz
}

/* Questions & exercises */
Table questions {
  id int [pk, increment]
  question text
  level int
  created_at timestamptz
  updated_at timestamptz
}

Table user_exercises {
  id int [pk, increment]
  user_id int [ref: > users.id]
  question_id int [ref: > questions.id]
  user_answer text
  is_correct boolean
  created_at timestamptz
}

/* User levels */
Table user_levels {
  user_id int [pk, ref: > users.id]
  current_level int
}

/* G3: Events hub */
Table events {
  id int [pk, increment]
  host_user_id int [ref: > users.id]
  department_id int [ref: > departments.id]
  image_url text
  title varchar
  description text
  total_seats int
  start_at timestamptz
  end_at timestamptz
  address_id int [ref: > addresses.id]
  created_at timestamptz
  updated_at timestamptz
}

Table event_bookmarks {
  user_id int [ref: > users.id]
  event_id int [ref: > events.id]
  created_at timestamptz
  Indexes {
    (user_id, event_id) [pk]
  }
}

/* G12: Healthcare */
Table patients {
  id int [pk, increment]
  user_id int [ref: > users.id]
  emergency_contact varchar
  created_at timestamptz
}

Table facilities {
  id int [pk, increment]
  name varchar
  facility_type varchar
  address_id int [ref: > addresses.id]
  phone varchar
  location geometry
  emergency_services boolean
  department_id int [ref: > departments.id]
  created_at timestamptz
}

Table beds {
  id int [pk, increment]
  facility_id int [ref: > facilities.id]
  bed_number varchar
  bed_type varchar
  status varchar
  patient_id int [ref: > patients.id]
  admission_date timestamptz
  created_at timestamptz
}

Table appointments {
  id int [pk, increment]
  patient_id int [ref: > patients.id]
  facility_id int [ref: > facilities.id]
  staff_user_id int [ref: > users.id]
  appointment_at timestamptz
  type varchar
  status varchar
  created_at timestamptz
}

Table prescriptions {
  id int [pk, increment]
  patient_id int [ref: > patients.id]
  prescriber_user_id int [ref: > users.id]
  facility_id int [ref: > facilities.id]
  medication_name varchar
  quantity int
  status varchar
  created_at timestamptz
}

Table ambulances {
  id int [pk, increment]
  vehicle_number varchar
  status varchar
  current_location geometry
  base_facility_id int [ref: > facilities.id]
  created_at timestamptz
}

Table emergency_calls {
  id int [pk, increment]
  patient_id int [ref: > patients.id]
  caller_phone varchar
  emergency_type varchar
  severity varchar
  address_id int [ref: > addresses.id]
  ambulance_id int [ref: > ambulances.id]
  facility_id int [ref: > facilities.id]
  status varchar
  created_at timestamptz
}

Table payments {
  id int [pk, increment]
  patient_id int [ref: > patients.id]
  facility_id int [ref: > facilities.id]
  service_type varchar
  service_id int
  amount numeric
  currency char(3)
  payment_method varchar
  insurance_coverage numeric
  patient_copay numeric
  status varchar
  payment_date timestamptz
  created_at timestamptz
}

Table team_integrations {
  id int [pk, increment]
  team_name varchar
  external_table varchar
  external_id varchar
  data_type varchar
  status varchar
  additional_data jsonb
  created_at timestamptz
}

/* G11: Wallets & Cards */
Table wallets {
  id int [pk, increment]
  owner_id int [ref: > users.id]
  wallet_type wallet_type
  organization_type varchar
  balance numeric
  status wallet_status
  created_at timestamptz
  updated_at timestamptz
}

Table wallet_transactions {
  id int [pk, increment]
  wallet_id int [ref: > wallets.id]
  transaction_type transaction_type
  amount numeric
  target_wallet_id int [ref: > wallets.id]
  target_service varchar
  description varchar
  created_at timestamptz
}

Table insurance_cards {
  id int [pk, increment]
  user_id int [ref: > users.id]
  balance numeric
  card_number varchar
  status wallet_status
  created_at timestamptz
  updated_at timestamptz
}

Table metro_cards {
  id int [pk, increment]
  user_id int [ref: > users.id]
  balance numeric
  card_number varchar
  status wallet_status
  created_at timestamptz
  updated_at timestamptz
}

Table card_transactions {
  id int [pk, increment]
  card_id int
  card_type varchar
  transaction_type card_transaction_type
  transaction_category transaction_category
  reference varchar
  amount numeric
  description varchar
  created_at timestamptz
}

/* G10: Traffic */
Table intersections {
  id int [pk, increment]
  location geometry
}

Table traffic_lights {
  id int [pk, increment]
  intersection_id int [ref: > intersections.id]
  road_id int [ref: > roads.id]
  ip_address inet
  location geometry
  status int
  current_color smallint
  density_level smallint
  auto_mode boolean
  last_updated timestamptz
}

Table roads {
  id int [pk, increment]
  name varchar
  start_intersection_id int [ref: > intersections.id]
  end_intersection_id int [ref: > intersections.id]
  length_meters int
}

Table light_requests {
  id int [pk, increment]
  traffic_light_id int [ref: > traffic_lights.id]
  requested_at timestamptz
}

Table vehicles {
  id int [pk, increment]
  user_id int [ref: > users.id]
  current_location geometry
  vehicle_plate varchar
}

Table traffic_emergencies {
  id int [pk, increment]
  user_id int [ref: > users.id]
  accident_location geometry
  destination_hospital varchar
  status varchar
  ambulance_vehicle_id int [ref: > vehicles.id]
  created_at timestamptz
}

/* G13: Emergency reports */
Table report_categories {
  id int [pk, increment]
  name varchar
  created_at timestamptz
  updated_at timestamptz
}

Table emergency_reports {
  id int [pk, increment]
  user_id int [ref: > users.id]
  image_url varchar
  description text
  location geometry
  ambulance_service boolean
  level report_level
  status report_status
  report_category_id int [ref: > report_categories.id]
  created_at timestamptz
  updated_at timestamptz
}

Table emergency_contacts {
  id int [pk, increment]
  user_id int [ref: > users.id]
  contact_name varchar
  phone varchar
}

Table alerts {
  id int [pk, increment]
  report_id int [ref: > emergency_reports.id]
  user_id int [ref: > users.id]
  message text
  status alert_status
  area geometry
  sent_at timestamptz
}

Table sos {
  sos_id int [pk, increment, not null]
  user_id int [not null, ref: > users.id]
  location geometry
  status sos_status [default: "open"]
  created_at timestamp
  updated_at timestamp
}


Table fcm_tokens{
  id int [pk, increment]
  user_id int [ref: - users.id]
  fcm_tokens text
  created_at timestamp
  updated_at timestamp
}


/* Messaging */
Table conversations {
  id int [pk, increment]
  conversation_name varchar
  created_at timestamptz
}

Table conversation_participants {
  conversation_id int [ref: > conversations.id]
  user_id int [ref: > users.id]
  Indexes {
    (conversation_id, user_id) [pk]
  }
}

Table messages {
  id int [pk, increment]
  conversation_id int [ref: > conversations.id]
  sender_id int [ref: > users.id]
  message_text text
  sent_at timestamptz
}

/* G5: Air quality & G14: weather */
Table air_quality {
  id int [pk, increment]
  location_id int [ref: > addresses.id]
  aqi numeric
  pm25 numeric
  pm10 numeric
  co numeric
  no2 numeric
  so2 numeric
  o3 numeric
  category air_quality_category
  measured_at timestamptz
}

Table weather_data {
  id int [pk, increment]
  location_id int [ref: > addresses.id]
  temperature numeric
  feel_temperature numeric
  humidity numeric
  wind_speed numeric
  wind_direction varchar
  rainfall_probability numeric
  created_at timestamptz
  updated_at timestamptz
}

/* G8: Transportation */
Table digital_cards {
  id int [pk, increment]
  user_id int [ref: > users.id]
  status varchar
}

Table transportation_vehicle_types {
  id int [pk, increment]
  name varchar
}

Table routes {
  id int [pk, increment]
  route_name varchar
  vehicle_type_id int [ref: > transportation_vehicle_types.id]
}

Table stops {
  id int [pk, increment]
  name varchar
  location geometry
}

Table route_stops {
  id int [pk, increment]
  route_id int [ref: > routes.id]
  stop_id int [ref: > stops.id]
  stop_order int
  travel_time_to_next_stop int
}

Table transportation_transactions {
  id int [pk, increment]
  card_id int [ref: > digital_cards.id]
  route_id int [ref: > routes.id]
  amount numeric
  status varchar
  created_at timestamptz
}

/* G9: Apartments & POI */
Table apartments {
  id int [pk, increment]
  name varchar
  rating numeric
  phone varchar
}

Table apartment_addresses {
  id int [pk, increment]
  apartment_id int [ref: > apartments.id]
  address_id int [ref: > addresses.id]
  created_at timestamptz
  updated_at timestamptz
}

Table poi_categories {
  id int [pk, increment]
  category_name varchar
  created_at timestamptz
  updated_at timestamptz
}

Table poi_locations {
  id int [pk, increment]
  name varchar
  location geometry
  category_id int [ref: > poi_categories.id]
}

/* G15: Waste management */
Table waste_types {
  id int [pk, increment]
  type_name varchar
  typical_weight_kg numeric
}

Table waste_event_statistics {
  id int [pk, increment]
  event_id int [ref: > events.id]
  waste_type_id int [ref: > waste_types.id]
  collection_date timestamptz
  total_collection_weight numeric
}

Table power_bi_reports {
  id int [pk, increment]
  waste_event_statistic_id int [ref: > waste_event_statistics.id]
  report_type varchar
  report_date timestamptz
  created_at timestamptz
}

/* G7: BI dims/facts */
Table dim_time {
  id int [pk, increment]
  date date
  year int
  month int
  day int
  hour int
  week_day varchar
}

Table dim_location {
  id int [pk, increment]
  address_id int [ref: > addresses.id]
}

Table dim_facility {
  id int [pk, increment]
  facility_id int [ref: > facilities.id]
}

Table fact_traffic {
  id int [pk, increment]
  time_id int [ref: > dim_time.id]
  location_id int [ref: > dim_location.id]
  speed_kmh numeric
  accident_flag boolean
  closure_flag boolean
}

Table fact_waste {
  id int [pk, increment]
  time_id int [ref: > dim_time.id]
  location_id int [ref: > dim_location.id]
  bin_fill_level_percent int
  recycling_tonnage numeric
}

Table fact_healthcare {
  id int [pk, increment]
  time_id int [ref: > dim_time.id]
  facility_id int [ref: > dim_facility.id]
  wait_time_minutes int
  alert_type varchar
  cases_reported int
}

Table report_metadata {
  id int [pk, increment]
  title varchar
  description text
  category_id int [ref: > poi_categories.id]
  created_by_user_id int [ref: > users.id]
  last_updated timestamptz
}


/* G16 Community Map */
Table marker {
  id int [pk, increment]
  markerTypeID int [ref: - marker_type.id]
  description text
  location geometry //PostGIS Point(4326)
  created_at timestamp
  updated_at timestamp
}

Table marker_type {
  id int [pk, increment]
  markerTypeIcon varchar(255)
  markerTypeColor varchar(255)
  created_at timestamp
  updated_at timestamp
}
