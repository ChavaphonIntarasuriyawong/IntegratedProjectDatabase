//// -----------------------------------------------------------
//// -- Project: Smart City DB
//// -- Database: PostgreSQL
//// -- Last Updated: 2025-09-27
//// -----------------------------------------------------------

// User Features
Table roles {
  id int [pk, increment]
  role_name varchar(50)
}

Enum genders {
  MALE
  FEMALE
  NONE
}

Table departments {
  id int [pk, increment]
  department_name varchar(255)
  created_at timestamp
  updated_at timestamp
}

Table users {
  id int [pk, increment]
  username varchar(25)
  first_name varchar(255)
  middle_name varchar(255)
  last_name varchar(255)
  gender genders
  role_id int [ref: > roles.id]
  password_hash varchar(256) [not null]
  email varchar(255) [unique]
  phone varchar(15) [unique]
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  zip_code varchar(20)
  more_address_detail text
  birth_date timestamp [not null]
  created_at timestamp
  updated_at timestamp
}

Table users_departments {
  user_id int [pk, ref: > users.id]
  department_id int [pk, ref: > departments.id]
}

// Authentication
Table sessions {
  session_id varchar(255)
  user_id int [ref: - users.id]
  created_at timestamp
  expires_at timestamp
  last_accessed timestamp
}

Table refresh_tokens {
  id int [pk, increment]
  user_id int [ref: - users.id]
  refresh_token varchar[512]
  created_at timestamp
  expires_at timestamp
}

// G4 Freecycle
Table freecycle_posts {
  id int [pk, increment]
  item_name varchar(100) [not null]
  item_weight decimal
  photo_url text [not null]
  description text [not null]
  donater_id int [not null, ref: > users.id]
  donate_to_department_id int [ref: > departments.id]
  is_given boolean [default: false]
  created_at timestamp
  updated_at timestamp
}

Table freecycle_categories {
  id int [pk, increment]
  category_name varchar(100)
  created_at timestamp
  updated_at timestamp
}

Table freecycle_posts_categories {
  post_id int [pk, ref: > freecycle_posts.id]
  category_id int [pk, ref: > freecycle_categories.id]
}

Enum freecycle_request_status {
  PENDING
  ACCEPTED
  REJECTED
}

Table receiver_requests {
  id int [pk, increment]
  post_id int [ref: > freecycle_posts.id]
  receiver_id int [ref: > users.id]
  status freecycle_request_status [default: 'PENDING']
  created_at timestamp
  updated_at timestamp
}

// G6 Volunteer
Enum volunteer_event_status {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

Table volunteer_events {
  id int [pk, increment]
  user_created_event_id int [ref: > users.id]
  for_department id [ref: - departments.id]
  image text
  title varchar(255) [not null]
  description text [not null]
  current_participator int [default: 0, not null]
  avaliable_seat int [not null, default: 0]
  total_seat int [not null, default: 1]
  start_date timestamp
  end_date timestamp
  register_deadline timestamp
  district varchar(255)
  subdistrict varchar(255)
  more_location_detail text
  status volunteer_event_status
  created_at timestamp
  updated_at timestamp
}

Table volunteer_event_participation {
  id int [pk, increment]
  volunteer_event_id int [ref: > volunteer_events.id]
  participated_user_id int [ref: > users.id]
  created_at timestamp
  updated_at timestamp
}

// G1 Know AI Courses
Enum course_types {
  ONLINE
  ONSITE
  ONLINE_AND_ONSITE
}

Table courses {
  id int [pk, increment]
  author_id int [ref: > users.id]
  course_name varchar(255) [not null]
  course_description text [not null]
  course_type course_types [not null]
  cover_image text [not null]
  created_at timestamp
  updated_at timestamp
}

Table online_courses {
  id int [pk, increment]
  video_name varchar(100) [not null]
  video_description text [not null]
  duration_minutes decimal [not null]
  video_order int [not null]
  video_file_path text [not null]
  course_id int [not null, ref: > courses.id]
  created_at timestamp
  updated_at timestamp
}

Table onsites {
  id int [pk, increment]
  course_id int [ref: > courses.id]
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  more_address_detail text
  duration_hours decimal
  event_datetime timestamp [not null]
  registration_deadline timestamp [not null]
  avaliable_seat int [not null, default: 0]
  total_seat int [not null, default: 1]
  created_at timestamp
  updated_at timestamp
}

Table onsite_enrollments {
  id int [pk, increment]
  onsite_id int [ref: > onsites.id]
  user_id int [pk, ref: > users.id]
}

Table questions {
  id int [pk, increment]
  question text
  level int
  created_at timestamp
  updated_at timestamp
}

Table user_exercises {
  id int [pk, increment]
  user_id int [ref: > users.id]
  question_id int [ref: > questions.id]
  user_answer text
  is_correct boolean
  created_at timestamp
  updated_at timestamp
}

Table user_level {
  user_id int [ref: - users.id]
  current_lv int
}

// G3 Event Hub
Table event {
  id int [pk, increment]
  host_event_id int [ref: > users.id]
  from_department in [ref: - departments.id]
  image text
  title varchar(255)
  description varchar(255)
  avaliable_seat int
  total_seat int
  start_date timestamp
  end_date timestamp
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  more_location_detail text
  created_at timestamp
  updated_at timestamp
}

Table bookmark {
  user_id int [pk, ref: > users.id]
  event_id int [pk, ref: > event.id]
  createdAt timestamp
}

// G12 Healthcare
Table patients {
  patient_id int [pk, increment]
  user_id int [ref: - users.id]
  emergency_contact varchar(200)
  finance_id int
  housing_id int
  sos_id int
  created_at timestamp
}

Table facilities {
  facility_id int [pk, increment]
  name varchar(255)
  type varchar(50)
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  zip_code varchar(20)
  more_address_detail text
  phone varchar(20)
  latitude decimal(10,8)
  longitude decimal(11,8)
  emergency_services boolean
  finance_merchant_id int
  housing_zone varchar(100)
  sos_code varchar(50)
  department_id int [ref: > departments.id]
  created_at timestamp
}

Table beds {
  bed_id int [pk, increment]
  facility_id int [ref: > facilities.facility_id]
  bed_number varchar(20)
  bed_type varchar(50)
  status varchar(20)
  patient_id int [ref: - patients.patient_id]
  admission_date timestamp
  finance_billing_id int
  sos_priority integer
}

Table appointments {
  appointment_id int [pk, increment]
  patient_id int [ref: > patients.patient_id]
  facility_id int [ref: > facilities.facility_id]
  user_id int [ref: > users.id]
  appointment_datetime timestamp
  type varchar(50)
  status varchar(20)
  finance_payment_id int
  housing_transport_id int
  sos_emergency boolean
  created_at timestamp
}

Table prescriptions {
  prescription_id int [pk, increment]
  patient_id int [ref: > patients.patient_id]
  user_id int [ref: > users.id]
  facility_id int [ref: > facilities.facility_id]
  medication_name varchar(255)
  quantity integer
  status varchar(20)
  finance_payment_id int
  housing_delivery_id int
  sos_critical boolean
  created_at timestamp
}

Table ambulances {
  ambulance_id int [pk, increment]
  vehicle_number varchar(50)
  status varchar(20)
  current_latitude decimal(10,8)
  current_longitude decimal(11,8)
  base_facility_id int [ref: > facilities.facility_id]
  finance_rate decimal(10,2)
  housing_coverage_zones json
  sos_priority integer
  created_at timestamp
}

Table emergency_calls {
  emergency_id int [pk, increment]
  patient_id int [ref: > patients.patient_id]
  caller_phone varchar(20)
  emergency_type varchar(50)
  severity varchar(20)
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  zip_code varchar(20)
  more_address_detail text
  ambulance_id int [ref: > ambulances.ambulance_id]
  facility_id int [ref: > facilities.facility_id]
  status varchar(20)
  finance_billing_id int
  housing_unit varchar(100)
  sos_incident_id int
  created_at timestamp
}

Table payments {
  payment_id int [pk, increment]
  patient_id int [ref: > patients.patient_id]
  facility_id int [ref: > facilities.facility_id]
  service_type varchar(50)
  service_id int
  amount decimal(10,2)
  currency varchar(3)
  payment_method varchar(50)
  insurance_coverage decimal(10,2)
  patient_copay decimal(10,2)
  status varchar(20)
  payment_date timestamp
  finance_transaction_id int
  insurance_claim_id int
  created_at timestamp
  updated_at timestamp
}

Table team_integrations {
  integration_id int [pk, increment]
  team_name varchar(50)
  healthcare_table varchar(50)
  healthcare_id varchar
  external_id varchar(100)
  data_type varchar(50)
  status varchar(20)
  additional_data json
  created_at timestamp
}

// G11 Financial
Enum wallet_type {
  individual
  organization
}

Enum wallet_status {
  active
  suspended
}

Table wallets {
  wallet_id int [pk, increment]
  owner_id int [unique, ref: - users.id]
  wallet_type wallet_type
  organization_type varchar(100)
  balance decimal [default: 0.0]
  status wallet_status
  created_at timestamp
  updated_at timestamp
}

Enum transaction_type {
  top_up
  transfer_in
  transfere_out
  transfer_to_service
}

Enum target_services {
  insurance
  metro
  null
}

Table wallet_transactions {
  transaction_id int [pk, increment]
  wallet_id int [ref: > wallets.wallet_id]
  transaction_type transaction_type
  amount decimal
  target_wallet_id int
  target_service target_services
  description varchar(255)
  created_at timestamp
}

Table insurance_cards {
  card_id int [pk, increment]
  citizen_id int [ref: > users.id]
  balance decimal [default: 0.0]
  card_number int [unique]
  status wallet_status
  created_at timestamp
  updated_at timestamp
}

Table metro_cards {
  card_id int [pk, increment]
  citizen_id int [ref: > users.id]
  balance decimal [default: 0.0]
  card_number int [unique]
  status wallet_status
  created_at timestamp
  updated_at timestamp
}

Enum card_transaction_type {
  top_up
  charge
  refund
}

Enum transaction_category {
  insurance
  metro
}

Table transaction {
  transaction_id int [pk, increment]
  card_id int [ref: > insurance_cards.card_id]
  transaction_type card_transaction_type
  transaction_category transaction_category
  reference varchar(50)
  amount decimal [default: 0.0]
  description varchar(255)
  created_at timestamp
}

// G10 Traffic
Table traffic_light {
  light_id int [pk, increment]
  intersection_id int [ref: < intersection.intersection_id]
  road_id int [ref: < road.road_id]
  ip_address varchar(255)
  latitude varchar(100)
  longitude varchar(100)
  status boolean
  current_color int
  density_level int
  auto_mode boolean
  last_updated timestamp
}

Table intersection {
  intersection_id int [pk, increment]
  latitude varchar(100)
  longitude varchar(100)
}

Table light_request {
  request_id int [pk, increment]
  light_id int [ref: > traffic_light.light_id]
  request_time timestamp
}

Table road {
  road_id int [pk, increment]
  light_id int [ref: > traffic_light.light_id]
  intersection_id_start int [ref: > intersection.intersection_id]
  intersection_id_end int [ref: > intersection.intersection_id]
  length int
}

Enum traffic_emergency_status {
  active
  resolve
}

Table vehicle {
  vehicle_id int [pk, increment]
  user_id int [ref: > users.id]
  current_latitude varchar(100)
  current_longitude varchar(100)
  vehicle_plate varchar(10)
}

Table traffic_emergency_request {
  emergency_request int [pk, increment]
  user_id int [ref: > users.id]
  accident_latitude varchar(100)
  accident_longitude varchar(100)
  destination_hospital varchar(255)
  status traffic_emergency_status
  ambulance_id int [ref: > vehicle.vehicle_id]
}

// G13 Emergency Reports
Enum level {
  near_miss
  minor
  moderate
  major
  lethal
}

Enum report_category {
  traffic
  disaster
  crime
}// change to use table dynamic

Enum user_noti_status {
  read
  unread
  sent
}

Enum report_status {
  pending
  verified
  resolved
}

Enum sos_status {//add
  open
  closed
}

Table reports {
  report_id int [pk, increment, not null]
  user_id int [not null, ref: > users.id]
  image varchar(255) [not null]
  description varchar(255) [not null]
  latitude decimal(10,6)// change
  longitude decimal(10,6)// change
  level level
  ambulance_service boolean [default: false]//add
  status report_status [default: "pending"]// add
  category report_category
  updated_at timestamp
  created_at timestamp
}

Table sos {// add
  sos_id int [pk, increment, not null]
  user_id int [not null, ref: > users.id]
  latitude decimal(10,6)
  longitude decimal(10,6)
  status sos_status [default: "open"]
}


Table emergency_contacts {
  contact_id int [pk, increment, not null]
  user_id int [not null, ref: > users.id]
  contact_name varchar(255) [not null]
  phone varchar(10)
}

Table admin_noti {//add
  admin_noti_id int [pk, increment, not null]
  report_id int [not null, ref: > reports.report_id]
  sent_at timestamp
}

Table user_noti {//add
  user_noti_id int [pk, increment, not null]
  report_id int [not null, ref: > reports.report_id]
  message text [not null]
  area varchar(255)
  status user_noti_status
  sent_at timestamp
}

Table users_contacts {
  contact_id int [pk, increment, not null]
  user_id int [not null, ref: > users.id]
  contact_user_id int [not null, ref: > users.id]
}

Table conversations {
  conversation_id int [pk, increment, not null]
  conversation_name varchar(255)
}

Table messages {
  message_id int [pk, increment, not null]
  sender_id int [not null, ref: > users.id]
  recipient_id int [not null, ref: > users.id]
  message_text text
  sent_at timestamp
  conversation_id int [not null, ref: > conversations.conversation_id]
}

// G5 Air Quality
Enum categories {
  GOOD
  MODERATE
  UNHEALTHY
  HAZARDDOUS
}

Table air_quality {
  id int [pk, increment]
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  more_address_detail text
  aqi decimal
  pm25 decimal
  pm10 decimal
  co decimal
  no2 decimal
  so2 decimal
  o3 decimal
  category categories
  created_at timestamp
}

Table weather_context {
  id int [pk, increment]
  rain_forecast decimal
  created_at timestamp
}

Table traffic_context {
  id int [pk, increment]
  congestion_level decimal
  created_at timestamp
}

// G8 Transportation
enum transportation_digital_card_status {
  active
  inactive
}

table digital_card {
  card_id int [pk, increment]
  user_id int [ref: > users.id]
  status transportation_digital_card_status
}

enum transportation_card_transaction_status {
  pending
  confirmed
  failed
}

table transportation_vehicle_type {
  type_id int [pk, increment]
  type_name varchar(100)
}

table route {
  route_id int [pk, increment]
  route_name varchar(255)
  type_id int [ref: > transportation_vehicle_type.type_id]
}

table transportation_card_transaction {
  transaction_id int [pk, increment]
  card_id int [ref: > digital_card.card_id]
  route_id int [ref: > route.route_id]
  amount decimal
  status transportation_card_transaction_status
  timestamp timestamp
}

enum transportation_vehicle_status {
  active
  maintenance
}

table transportation_vehicle {
  vehicle_id int [pk, increment]
  type_id int [ref: > transportation_vehicle_type.type_id]
  route_id int [ref: > route.route_id]
  current_latitude varchar(100)
  current_longitude varchar(100)
  status transportation_vehicle_status
}

table stop {
  stop_id int [pk, increment]
  stop_name varchar(255)
  stop_latitude varchar(100)
  stop_longitude varchar(100)
}

table route_stop {
  route_stop_id int [pk, increment]
  route_id int [ref: > route.route_id]
  stop_id int [ref: > stop.stop_id]
  stop_order int
  travel_time_to_next_stop int [note: "record in minutes"]
}

table transportation_user_request {
  request_id int [pk, increment]
  user_id int [ref: > users.id]
  origin_stop_id int [ref: > stop.stop_id]
  destination_stop_id int [ref: > stop.stop_id]
  fastest_route_id int [ref: > route.route_id]
  total_travel_time int [note: "record in minutes"]
  timestamp timestamp
}

// G9 Find Apartment
Table apartment {
  id int [pk, increment]
  apartment_name varchar(255)
  apartment_rating decimal
  apartment_phone varchar(15)
}

Table apartment_address {
  id int [pk, increment]
  apartment_id int [ref: - apartment.id]
  apartment_latitude decimal
  apartment_longitude decimal
  province varchar(255)
  district varchar(255)
  sub_district varchar(255)
  zip_code varchar(255)
  more_address_detail text [note: 'apartment number, road, etc.']
  created_at timestamp
  updated_at timestamp
}

Table poi_categories{
  id int [pk, increment]
  category_name varchar(255)
  created_at timestamp
  updated_at timestamp
}

Table poi_location {
  id int [pk, increment]
  poi_name varchar(255)
  poi_latitude decimal
  poi_longitude decimal
  category_id int [ref: > poi_categories.id]
}

// G15 Waste Management
Table waste_type {
  id int [pk, increment]
  type_name varchar(255)
  weight decimal
}

Table waste_event_statistic {
  id int [pk, increment]
  event_id int [ref: > event.id]
  waste_type_id int [ref: > waste_type.id]
  collection_date timestamp
  total_collection_weight decimal
}

Table power_bi_report {
  id int [pk, increment]
  waste_event_statistic_id int [ref: > waste_event_statistic.id]
  report_type varchar(255)
  report_date timestamp
}

// G7 Power BI Report Management
Table dim_time {
  time_id int [pk, increment]
  date timestamp
  year int
  month int
  day int
  hour int
  week_a_day varchar(255)
}

Table dim_location {
  location_id int [pk, increment]
  province varchar(255)
  district varchar(255)
  subdistrict varchar(255)
  latitude decimal
  longitude decimal
}

Table dim_facility {
  facility_id int [pk, increment]
  facility_type varchar(255)
  facility_name varchar(255)
  location_id int [ref: > dim_location.location_id]
}

Table fact_traffic {
  traffic_id int [pk, increment]
  time_id int [ref: > dim_time.time_id]
  location_id int [ref: > dim_location.location_id]
  speed_kmh decimal
  accident_flag boolean
  closure_flag boolean
}

Table fact_waste {
  waste_id int [pk, increment]
  time_id int [ref: > dim_time.time_id]
  location_id int [ref: > dim_location.location_id]
  bin_fill_level_percent int
  recycling_tonnage decimal
}

Table fact_healthcare {
  health_id int [pk, increment]
  time_id int [ref: > dim_time.time_id]
  facility_id int [ref: > dim_facility.facility_id]
  wait_time_minutes int
  alert_type varchar(255)
  cases_reported int
}

Table fact_weather {
  weather_id int [pk, increment]
  time_id int [ref: > dim_time.time_id]
  location_id int [ref: > dim_location.location_id]
  temperature decimal
  aqi int
  warning_flag boolean
}

Table fact_demographic {
  demographic_id int [pk, increment]
  time_id int [ref: > dim_time.time_id]
  location_id int [ref: > dim_location.location_id]
  population_total int
}

Table dim_user {
  user_id int [pk, increment]
  role varchar
  department varchar
}

Table dim_category {
  category_id int [pk, increment]
  category_name varchar(255)
}

Table report_metadata {
  report_id int [pk, increment]
  title varchar(255)
  description varchar(255)
  category_id int [ref: > dim_category.category_id]
  created_by int [ref: > dim_user.user_id]
  last_updated timestamp
}

// G16 Community map
Table marker_type {
  id int [pk, increment]
  marker_icon varchar(255)
  marker_color varchar(255)
  created_at timestamp
  updated_at timestamp
}

Table map_marker {
  id int [pk, increment]
  marker_type_id int [ref: > marker_type.id]
  display_name varchar(255)
  description varchar(255)
  created_at timestamp
  updated_at timestamp
}

// G14 Weather report
Table weather_data {
  id int [pk, increment]
  temperature decimal
  feel_temperature decimal
  humidity decimal
  wind decimal
  wind_direction varchar(255)
  rainfall_probability decimal
  created_at timestamp
  updated_at timestamp
}
